import type { ParsedFile } from "../diff/types";
import {
  formatInlineCommentWithSuggestion,
  isValidSuggestion,
} from "../github/suggestion-formatter";
import type { AdaptiveContext } from "./memory/types";
import { buildAdaptivePromptSection, hasValidContext } from "./memory/context-builder";

// システムプロンプト
export const REVIEW_SYSTEM_PROMPT = `あなたは経験豊富なシニアソフトウェアエンジニアで、コードレビューのエキスパートです。
あなたの役割は、Pull Requestの変更を分析し、建設的で実行可能なフィードバックを提供することです。

## レビュー原則

1. **建設的であること**: 批判ではなく改善提案を
2. **具体的であること**: 一般論ではなく具体的なコードを指摘
3. **優先度を明確に**: CRITICALは必ず修正、NITPICKは任意
4. **理由を説明**: なぜ問題なのか、なぜ提案が有効なのか

## 深刻度の定義

- **CRITICAL**: セキュリティ脆弱性、データ損失、本番障害につながる問題
- **IMPORTANT**: バグ、パフォーマンス問題、設計上の問題
- **INFO**: ベストプラクティス、可読性の改善
- **NITPICK**: スタイル、命名規則、軽微な改善

## 出力形式

日本語で回答してください。コードブロックは適切な言語タグを使用してください。`;

// レビュープロンプト生成
export function buildReviewPrompt(params: {
  prTitle: string;
  prBody: string;
  files: ParsedFile[];
  diffContent: string;
  ragContext?: string;
  adaptiveContext?: AdaptiveContext;
}): string {
  const { prTitle, prBody, files, diffContent, ragContext, adaptiveContext } = params;

  const fileList = files
    .map((f) => `- ${f.newPath} (${f.type}: +${f.additions}/-${f.deletions})`)
    .join("\n");

  let prompt = `## Pull Request情報

**タイトル**: ${prTitle}

**説明**:
${prBody || "(説明なし)"}

## 変更ファイル一覧

${fileList}

## Diff内容

\`\`\`diff
${diffContent}
\`\`\`
`;

  if (ragContext) {
    prompt += `
## 関連コードコンテキスト（RAG）

以下は変更に関連する既存コードの抜粋です。レビュー時の参考にしてください。

${ragContext}
`;
  }

  // 適応コンテキストを追加
  if (adaptiveContext && hasValidContext(adaptiveContext)) {
    prompt += `
${buildAdaptivePromptSection(adaptiveContext)}
`;
  }

  prompt += `
## タスク

上記のPull Requestをレビューしてください。以下を出力してください：

1. **summary**: 変更内容の総合的なサマリー（何を変更したか、なぜ変更したか）
2. **walkthrough**: 各ファイルの変更概要
3. **comments**: 具体的なインラインコメント（問題点や改善提案）
4. **diagram**: （必要な場合のみ）アーキテクチャの変更を示すMermaidダイアグラム

コメントには必ず正確な行番号を指定してください。行番号はDiff内の新しいファイルの行番号を使用してください。

## 関連性スコアリング

各コメントには関連性スコア（relevanceScore）を1-10で付けてください：

### スコア基準
- **9-10 (HIGH)**: 必ず対応すべき重要な問題。セキュリティ、バグ、クラッシュの可能性
- **7-8 (MEDIUM)**: 対応を推奨する問題。パフォーマンス、設計改善、ベストプラクティス
- **5-6 (LOW)**: 参考程度の指摘。可読性向上、軽微な改善
- **1-4**: 非常に軽微またはPRの目的に関係ない指摘

### 評価観点
1. **PRの目的との関連性**: この指摘はPRの変更内容に直接関係するか？
2. **影響度**: 問題を放置した場合の影響は大きいか？
3. **実行可能性**: 提案は具体的で実装可能か？
4. **正確性**: コードの解釈は正しいか？

低スコア（5未満）のコメントはフィルタリングされる可能性があります。`;

  return prompt;
}

// PRサマリーコメント生成
export function buildSummaryComment(params: {
  summary: string;
  walkthrough: Array<{ path: string; summary: string; changeType: string }>;
  diagram?: string | null;
  commentsCount: number;
  criticalCount: number;
  importantCount: number;
}): string {
  const {
    summary,
    walkthrough,
    diagram,
    commentsCount,
    criticalCount,
    importantCount,
  } = params;

  let comment = `## 🐴 CodeHorse Review Summary

${summary}

### 📁 変更ファイル

| ファイル | 変更タイプ | 概要 |
|----------|------------|------|
`;

  for (const file of walkthrough) {
    const typeEmoji = {
      add: "🆕",
      modify: "📝",
      delete: "🗑️",
      rename: "📛",
    }[file.changeType] || "📄";
    comment += `| \`${file.path}\` | ${typeEmoji} ${file.changeType} | ${file.summary} |\n`;
  }

  if (diagram) {
    comment += `
### 📊 アーキテクチャ図

\`\`\`mermaid
${diagram}
\`\`\`
`;
  }

  comment += `
### 📈 レビュー統計

- 💬 コメント数: ${commentsCount}
`;

  if (criticalCount > 0) {
    comment += `- 🔴 CRITICAL: ${criticalCount}\n`;
  }
  if (importantCount > 0) {
    comment += `- 🟠 IMPORTANT: ${importantCount}\n`;
  }

  comment += `
---
*🐴 Generated by [CodeHorse](https://github.com/codehorse)*`;

  return comment;
}

// インラインコメントのフォーマット
// GitHubネイティブのsuggestion block形式を使用
export function formatInlineComment(params: {
  body: string;
  severity: string;
  suggestion?: string;
  relevanceScore?: number;
  relevanceCategory?: string;
}): string {
  const { body, severity, suggestion, relevanceScore, relevanceCategory } = params;

  // 有効なsuggestionがある場合のみsuggestion blockを使用
  const validSuggestion = isValidSuggestion(suggestion) ? suggestion : undefined;

  return formatInlineCommentWithSuggestion({
    body,
    severity,
    suggestion: validSuggestion,
    relevanceScore,
    relevanceCategory,
  });
}
