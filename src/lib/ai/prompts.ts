import type { ParsedFile } from "../diff/types";

// ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
export const REVIEW_SYSTEM_PROMPT = `ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªã‚·ãƒ‹ã‚¢ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã€ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚
ã‚ãªãŸã®å½¹å‰²ã¯ã€Pull Requestã®å¤‰æ›´ã‚’åˆ†æã—ã€å»ºè¨­çš„ã§å®Ÿè¡Œå¯èƒ½ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã™ã‚‹ã“ã¨ã§ã™ã€‚

ã€é‡è¦ã€‘å‡ºåŠ›ã¯å¿…ãšJSONå½¢å¼ã®ã¿ã§è¡Œã£ã¦ãã ã•ã„ã€‚Markdownã‚„ãƒ†ã‚­ã‚¹ãƒˆã§ã®èª¬æ˜ã¯ç¦æ­¢ã§ã™ã€‚

## ãƒ¬ãƒ“ãƒ¥ãƒ¼åŸå‰‡

1. å»ºè¨­çš„ã§ã‚ã‚‹ã“ã¨: æ‰¹åˆ¤ã§ã¯ãªãæ”¹å–„ææ¡ˆã‚’
2. å…·ä½“çš„ã§ã‚ã‚‹ã“ã¨: ä¸€èˆ¬è«–ã§ã¯ãªãå…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ã‚’æŒ‡æ‘˜
3. å„ªå…ˆåº¦ã‚’æ˜ç¢ºã«: CRITICALã¯å¿…ãšä¿®æ­£ã€NITPICKã¯ä»»æ„
4. ç†ç”±ã‚’èª¬æ˜: ãªãœå•é¡Œãªã®ã‹ã€ãªãœææ¡ˆãŒæœ‰åŠ¹ãªã®ã‹

## æ·±åˆ»åº¦ã®å®šç¾©

- CRITICAL: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã€ãƒ‡ãƒ¼ã‚¿æå¤±ã€æœ¬ç•ªéšœå®³ã«ã¤ãªãŒã‚‹å•é¡Œ
- IMPORTANT: ãƒã‚°ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œã€è¨­è¨ˆä¸Šã®å•é¡Œ
- INFO: ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã€å¯èª­æ€§ã®æ”¹å–„
- NITPICK: ã‚¹ã‚¿ã‚¤ãƒ«ã€å‘½åè¦å‰‡ã€è»½å¾®ãªæ”¹å–„`;

// ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
export function buildReviewPrompt(params: {
  prTitle: string;
  prBody: string;
  files: ParsedFile[];
  diffContent: string;
  ragContext?: string;
}): string {
  const { prTitle, prBody, files, diffContent, ragContext } = params;

  const fileList = files
    .map((f) => `- ${f.newPath} (${f.type}: +${f.additions}/-${f.deletions})`)
    .join("\n");

  let prompt = `## Pull Requestæƒ…å ±

**ã‚¿ã‚¤ãƒˆãƒ«**: ${prTitle}

**èª¬æ˜**:
${prBody || "(èª¬æ˜ãªã—)"}

## å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

${fileList}

## Diffå†…å®¹

\`\`\`diff
${diffContent}
\`\`\`
`;

  if (ragContext) {
    prompt += `
## é–¢é€£ã‚³ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆRAGï¼‰

ä»¥ä¸‹ã¯å¤‰æ›´ã«é–¢é€£ã™ã‚‹æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®æŠœç²‹ã§ã™ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã®å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

${ragContext}
`;
  }

  prompt += `
## ã‚¿ã‚¹ã‚¯

ä¸Šè¨˜ã®Pull Requestã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

1. **summary**: å¤‰æ›´å†…å®¹ã®ç·åˆçš„ãªã‚µãƒãƒªãƒ¼ï¼ˆä½•ã‚’å¤‰æ›´ã—ãŸã‹ã€ãªãœå¤‰æ›´ã—ãŸã‹ï¼‰
2. **walkthrough**: å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´æ¦‚è¦
3. **comments**: å…·ä½“çš„ãªã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆå•é¡Œç‚¹ã‚„æ”¹å–„ææ¡ˆï¼‰
4. **diagram**: ï¼ˆå¿…è¦ãªå ´åˆã®ã¿ï¼‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å¤‰æ›´ã‚’ç¤ºã™Mermaidãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ 

## è¡Œç•ªå·ã«ã¤ã„ã¦ï¼ˆé‡è¦ï¼‰

ã‚³ãƒ¡ãƒ³ãƒˆã®è¡Œç•ªå·ã¯ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ãã ã•ã„ï¼š
- **Diffå†…ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹è¡Œ**ã®ã¿ã«ã‚³ãƒ¡ãƒ³ãƒˆã§ãã¾ã™
- è¡Œç•ªå·ã¯ã€Œ+ã€ã¾ãŸã¯ã€Œç©ºç™½ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¡Œï¼‰ã€ã§å§‹ã¾ã‚‹è¡Œã®ã€æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã§ã®è¡Œç•ªå·ã§ã™
- ã€Œ-ã€ã§å§‹ã¾ã‚‹å‰Šé™¤è¡Œã«ã¯ã‚³ãƒ¡ãƒ³ãƒˆã§ãã¾ã›ã‚“
- Diffã«è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„è¡Œï¼ˆçœç•¥ã•ã‚ŒãŸè¡Œï¼‰ã«ã¯ã‚³ãƒ¡ãƒ³ãƒˆã§ãã¾ã›ã‚“
- å„hunkã®ãƒ˜ãƒƒãƒ€ãƒ¼ã€Œ@@ -X,Y +A,B @@ã€ã®ã€ŒAã€ãŒæ–°ãƒ•ã‚¡ã‚¤ãƒ«ã®é–‹å§‹è¡Œç•ªå·ã§ã™

ä¾‹ï¼š
\`\`\`diff
@@ -10,5 +10,7 @@
 context line  // line 10 - ã‚³ãƒ¡ãƒ³ãƒˆå¯
+new line      // line 11 - ã‚³ãƒ¡ãƒ³ãƒˆå¯ï¼ˆè¿½åŠ è¡Œï¼‰
-deleted line  // ã‚³ãƒ¡ãƒ³ãƒˆä¸å¯ï¼ˆå‰Šé™¤è¡Œï¼‰
 context line  // line 12 - ã‚³ãƒ¡ãƒ³ãƒˆå¯
\`\`\``;

  return prompt;
}

// PRã‚µãƒãƒªãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
export function buildSummaryComment(params: {
  summary: string;
  walkthrough: Array<{ path: string; summary: string; changeType: string }>;
  diagram?: string | null;
  commentsCount: number;
  criticalCount: number;
  importantCount: number;
}): string {
  const {
    summary,
    walkthrough,
    diagram,
    commentsCount,
    criticalCount,
    importantCount,
  } = params;

  let comment = `## ğŸ´ CodeHorse Review Summary

${summary}

### ğŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | å¤‰æ›´ã‚¿ã‚¤ãƒ— | æ¦‚è¦ |
|----------|------------|------|
`;

  for (const file of walkthrough) {
    const typeEmoji = {
      add: "ğŸ†•",
      modify: "ğŸ“",
      delete: "ğŸ—‘ï¸",
      rename: "ğŸ“›",
    }[file.changeType] || "ğŸ“„";
    comment += `| \`${file.path}\` | ${typeEmoji} ${file.changeType} | ${file.summary} |\n`;
  }

  if (diagram) {
    comment += `
### ğŸ“Š ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

\`\`\`mermaid
${diagram}
\`\`\`
`;
  }

  comment += `
### ğŸ“ˆ ãƒ¬ãƒ“ãƒ¥ãƒ¼çµ±è¨ˆ

- ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆæ•°: ${commentsCount}
`;

  if (criticalCount > 0) {
    comment += `- ğŸ”´ CRITICAL: ${criticalCount}\n`;
  }
  if (importantCount > 0) {
    comment += `- ğŸŸ  IMPORTANT: ${importantCount}\n`;
  }

  comment += `
---
*ğŸ´ Generated by [CodeHorse](https://github.com/codehorse)*`;

  return comment;
}

// ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
export function formatInlineComment(params: {
  body: string;
  severity: string;
  suggestion?: string;
}): string {
  const { body, severity, suggestion } = params;

  const severityEmoji = {
    CRITICAL: "ğŸ”´",
    IMPORTANT: "ğŸŸ ",
    INFO: "ğŸ”µ",
    NITPICK: "âšª",
  }[severity] || "ğŸ’¬";

  let comment = `${severityEmoji} **[${severity}]**\n\n${body}`;

  if (suggestion) {
    comment += `\n\n**ğŸ’¡ ä¿®æ­£ææ¡ˆ:**\n\`\`\`suggestion\n${suggestion}\n\`\`\``;
  }

  return comment;
}
