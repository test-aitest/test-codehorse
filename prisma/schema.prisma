// CodeHorse Prisma Schema
// AI-Powered Code Review Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// Better Auth 必須テーブル
// ========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // リレーション
  accounts     Account[]
  sessions     Session[]
  repositories UserRepository[]
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String    // GitHub数値ID
  providerId            String    // "github"
  accessToken           String?   @db.Text
  refreshToken          String?   @db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?   @db.Text
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
}

// ========================================
// コアドメインモデル
// ========================================

model Repository {
  id             String      @id @default(cuid())
  githubRepoId   Int         @unique
  owner          String
  name           String
  fullName       String      // "owner/name"
  htmlUrl        String
  defaultBranch  String      @default("main")
  isPrivate      Boolean     @default(false)
  language       String?
  description    String?     @db.Text

  // GitHub App情報
  installationId Int

  // インデキシング状態
  indexStatus      IndexStatus @default(NOT_INDEXED)
  lastIndexedAt    DateTime?
  indexedCommitSha String?     // 最後にインデックスしたコミット

  // リポジトリ設定 (.codehorse.yaml のキャッシュ)
  config Json?

  // リレーション
  pullRequests     PullRequest[]
  users            UserRepository[]
  userFeedbacks    UserFeedback[]
  learningInsights LearningInsight[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([installationId])
  @@index([owner, name])
}

model UserRepository {
  userId       String
  repositoryId String
  permission   RepositoryPermission @default(READ)
  isConnected  Boolean              @default(true) // レビュー有効/無効

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@id([userId, repositoryId])
}

model PullRequest {
  id           String  @id @default(cuid())
  repositoryId String
  number       Int
  title        String
  state        PRState @default(OPEN)
  author       String

  // 増分レビュー用
  baseSha         String
  headSha         String
  lastReviewedSha String? // 最後にレビューしたコミット

  // リレーション
  repository           Repository            @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  reviews              Review[]
  conversationHistory  ConversationHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([repositoryId, number])
  @@index([repositoryId])
}

model Review {
  id            String       @id @default(cuid())
  pullRequestId String
  commitSha     String
  status        ReviewStatus @default(PENDING)

  // AI生成コンテンツ
  summary     String? @db.Text
  walkthrough String? @db.Text
  diagram     String? @db.Text // Mermaid形式

  // メタデータ
  tokenCount   Int?    // 使用トークン数
  processingMs Int?    // 処理時間(ms)
  errorMessage String? @db.Text

  // リレーション
  pullRequest PullRequest     @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  comments    ReviewComment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([pullRequestId])
  @@index([commitSha])
}

model ReviewComment {
  id              String @id @default(cuid())
  reviewId        String
  githubCommentId Int?   @unique // GitHub投稿後のID

  filePath     String
  lineNumber   Int
  diffPosition Int?     // GitHub API用のdiff内位置
  body         String   @db.Text
  severity     Severity @default(INFO)
  category     String?  // "security", "performance", "style" など

  // 修正提案
  suggestion String? @db.Text

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([reviewId])
}

// レビューエクスポート用の一時トークン
model ReviewExportToken {
  id        String   @id @default(cuid())
  token     String   @unique
  reviewId  String
  userId    String
  expiresAt DateTime
  consumed  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([expiresAt])
}

// ========================================
// 会話履歴・適応学習システム
// ========================================

// PR内の会話履歴を記録
model ConversationHistory {
  id            String      @id @default(cuid())
  pullRequestId String
  pullRequest   PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)

  type    ConversationType // レビュー、コメント、フィードバック
  role    ConversationRole // AI または ユーザー
  content String           @db.Text

  // メタデータ（ファイルパス、行番号など）
  metadata Json?

  createdAt DateTime @default(now())

  @@index([pullRequestId])
  @@index([pullRequestId, createdAt])
}

// ユーザーからのフィードバックを記録
model UserFeedback {
  id           String     @id @default(cuid())
  repositoryId String
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  commentId       String? // 元のレビューコメントID（ReviewComment.id）
  feedbackType    FeedbackType
  userComment     String?  @db.Text // ユーザーの補足コメント
  originalContent String   @db.Text // 元のAIコメント内容

  createdAt DateTime @default(now())

  @@index([repositoryId])
  @@index([repositoryId, feedbackType])
}

// リポジトリごとの学習インサイト
model LearningInsight {
  id           String     @id @default(cuid())
  repositoryId String
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  category    InsightCategory
  insight     String          @db.Text // 学習した傾向の説明
  confidence  Float // 信頼度 0.0 - 1.0
  sampleCount Int // この傾向を導き出したサンプル数

  updatedAt DateTime @updatedAt

  @@unique([repositoryId, category])
  @@index([repositoryId])
}

// 会話タイプ
enum ConversationType {
  REVIEW          // AIレビューコメント
  USER_COMMENT    // ユーザーの返信
  CHAT_RESPONSE   // チャットでの応答
  CHAT_QUESTION   // チャットでの質問
}

// 会話の役割
enum ConversationRole {
  AI
  USER
}

// フィードバックタイプ
enum FeedbackType {
  HELPFUL      // 役に立った
  NOT_HELPFUL  // 役に立たなかった
  INCORRECT    // 間違っている
  TOO_STRICT   // 厳しすぎる
  TOO_LENIENT  // 緩すぎる
}

// 学習インサイトのカテゴリ
enum InsightCategory {
  STYLE         // コードスタイルの傾向
  SEVERITY      // 厳しさレベルの傾向
  FOCUS_AREA    // 重視する観点
  LANGUAGE      // 言語・フレームワーク特有の傾向
  IGNORE_PATTERN // 無視すべきパターン
}


// ========================================
// Enum定義
// ========================================

enum IndexStatus {
  NOT_INDEXED
  INDEXING
  COMPLETED
  FAILED
}

enum PRState {
  OPEN
  CLOSED
  MERGED
}

enum ReviewStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum Severity {
  CRITICAL
  IMPORTANT
  INFO
  NITPICK
}

enum RepositoryPermission {
  ADMIN
  WRITE
  READ
}
